<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>Jio Cinema Live Matches</title>
    <meta name="referrer" content="no-referrer">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.10/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.10/controls.min.css" crossorigin="anonymous">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .video-container {
            width: 100vw;
            height: 56.25vw;
            max-height: 100vh;
            max-width: 177.78vh;
            margin: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .shaka-video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        #error-message {
            color: white;
            text-align: center;
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="error-message"></div>
    <div class="video-container">
        <div data-shaka-player-container style="width: 100%; height: 100%;" 
             class="shaka-mobile shaka-video-container" shaka-controls="true">
            <video autoplay muted playsinline data-shaka-player id="video" class="shaka-video"></video>
        </div>
    </div>

    <script>
        const API_URL = 'https://raw.githubusercontent.com/alex4528/jc_live/refs/heads/main/jevents_live.m3u';
        
        async function parseM3U(content) {
            const lines = content.split('\n');
            let streams = [];
            let currentStream = {};
            
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('#EXTINF:')) {
                    // Parse the EXTINF line
                    const match = line.match(/tvg-id="(\d+)"/);
                    if (match) {
                        currentStream.id = match[1];
                    }
                } else if (line && !line.startsWith('#')) {
                    // This is a URL line
                    currentStream.url = line;
                    if (currentStream.id) {
                        streams.push({...currentStream});
                    }
                    currentStream = {};
                }
            }
            return streams;
        }

        async function fetchStreamUrl(matchId) {
            try {
                const response = await fetch(API_URL);
                const content = await response.text();
                const streams = await parseM3U(content);
                
                const match = streams.find(s => s.id === matchId);
                if (match && match.url) {
                    return match.url;
                }
                throw new Error('Match not found or no stream available');
            } catch (error) {
                console.error('Error fetching stream URL:', error);
                throw error;
            }
        }

        async function attemptAutoplay(video) {
            try {
                await video.play();
                video.muted = false;
            } catch (error) {
                console.log('Autoplay with sound failed, trying muted:', error);
                try {
                    video.muted = true;
                    await video.play();
                } catch (secondError) {
                    console.error('Both autoplay attempts failed:', secondError);
                }
            }
        }

        async function init() {
            const video = document.getElementById('video');
            const ui = video['ui'];
            const controls = ui.getControls();
            const player = controls.getPlayer();
            const errorMessage = document.getElementById('error-message');
            
            window.player = player;
            window.ui = ui;

            const config = {
                addBigPlayButton: false,
                controlPanelElements: [
                    'play_pause',
                    'mute',
                    'volume',
                    'time_and_duration',
                    'spacer',
                    'quality',
                    'picture_in_picture',
                    'fullscreen',
                ]
            };
            ui.configure(config);

            const urlParams = new URLSearchParams(window.location.search);
            const matchId = urlParams.get("id");

            if (!matchId) {
                errorMessage.textContent = 'Match ID not provided';
                errorMessage.style.display = 'block';
                return;
            }

            document.addEventListener('keydown', (event) => {
                const videoElement = document.querySelector('video');
                const isFullScreen = () => !!document.fullscreenElement;

                switch(event.key) {
                    case 'f':
                        event.preventDefault();
                        isFullScreen() ? document.exitFullscreen() : videoElement.requestFullscreen();
                        break;
                    case ' ':
                        event.preventDefault();
                        video.paused ? video.play() : video.pause();
                        break;
                    case 'm':
                        event.preventDefault();
                        video.muted = !video.muted;
                        break;
                }
            });

            document.addEventListener('click', () => {
                if (video.muted) {
                    video.muted = false;
                }
            }, { once: true });

            player.addEventListener('error', onPlayerErrorEvent);
            controls.addEventListener('error', onUIErrorEvent);

            try {
                const streamUrl = await fetchStreamUrl(matchId);
                await player.load(streamUrl);
                console.log('Video loaded successfully!');
                await attemptAutoplay(video);
            } catch (error) {
                errorMessage.textContent = 'Error loading stream: ' + error.message;
                errorMessage.style.display = 'block';
                onPlayerError(error);
            }
        }

        function onPlayerErrorEvent(event) {
            onPlayerError(event.detail);
        }

        function onPlayerError(error) {
            console.error('Error code', error.code, 'object', error);
        }

        function onUIErrorEvent(event) {
            onPlayerError(event.detail);
        }

        function initFailed(error) {
            console.error('Unable to load the UI library!');
            document.getElementById('error-message').textContent = 'Failed to initialize player';
            document.getElementById('error-message').style.display = 'block';
        }

        document.addEventListener('shaka-ui-loaded', init);
        document.addEventListener('shaka-ui-load-failed', initFailed);
    </script>
</body>
</html>
